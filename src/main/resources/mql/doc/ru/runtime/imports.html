<h1>Вызов импортируемых функций</h1> 
<p><span>Для импорта функций во время выполнения mql4-программы используется раннее связывание. Это значит, что если в программе есть вызов импортируемой функции, то соответствующий модуль (ex4 или dll) загружается в процессе загрузки программы. Библиотеки MQL4 и DLL выполняются в потоке вызывающего модуля.</span></p> 
<p><span>Не рекомендуется использовать полностью квалифицированное имя загружаемого модуля вида </span><span style="font-style: italic;">Drive:\Directory\FileName.Ext</span><span>. Библиотеки MQL4 загружаются из папки </span><span style="font-style: italic;">terminal_dir\MQL4\Libraries</span><span>. Если библиотека не была найдена, то производится попытка загрузить библиотеку из папки </span><span style="font-style: italic;">terminal_dir\experts</span><span>.</span></p> 
<p><span>Системные библиотеки (DLL) загружаются по правилам операционной системы. Если библиотека уже загружена (например, другим экспертом и даже из другого клиентского терминала, запущенного параллельно), то обращение идет к уже загруженной библиотеке. В противном случае поиск идет в следующей последовательности:</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">1.</span><span>Директория из которой был запущен модуль, импортирующий dll. Под модулем понимается эксперт, скрипт, индикатор или библиотека EX4;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">2.</span><span>Директория каталог_данных_терминала\MQL4\Libraries (<a href="/constants/environment_state/terminalstatus#enum_terminal_info_string">TERMINAL_DATA_PATH</a>\MQL4\Libraries);</span></p>
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">3.</span><span>Директория, из которой был запущен клиентский терминал MetaTrader 4;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">4.</span><span>Системная директория;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">5.</span><span>Директория Windows;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">6.</span><span>Текущая директория;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">7.</span><span>Директории, перечисленные в системной переменной PATH.</span></p> 
<p><span>Если библиотека DLL использует в своей работе другую DLL, то в случае отсутствия второй DLL первая не сможет загрузиться.</span></p> 
<p><span>Перед загрузкой эксперта (скрипта, индикатора) формируется общий список всех библиотечных модулей EX4, которые предполагается использовать как из загружаемого эксперта (скрипта, индикатора), так и из библиотек из этого списка. Таким образом обеспечивается однократная загрузка многократно используемых библиотечных модулей EX4. Библиотеки пользуются <a href="/predefined">предопределенными переменными</a> вызвавшего их &nbsp;эксперта (скрипта, индикатора).</span></p>
<p><span>Поиск импортируемой библиотеки EX4 производится в следующей последовательности:</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">1.</span><span>Директория, путь к которой задается относительно директории импортирующего EX4 эксперта </span><span>(скрипта, индикатора)</span><span>;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">2.</span><span>Директория каталог_терминала\MQL4\Libraries;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 20px; margin: 2px 17px 3px 17px;"><span style="font-size:10pt; font-family: 'Trebuchet MS';color:#565656;display:inline-block;width:20px;margin-left:-20px">3.</span><span>Директория MQL4\Libraries в общей директории всех клиентских терминалов MetaTrader 4 (Common\MQL4\Libraries).</span></p> 
<p><span>Функции, <a href="/basis/preprosessor/import">импортируемые</a> из DLL в mql4-программу, должны обеспечивать соглашение о связях, принятое для функций Windows API. Для обеспечения такого соглашения в исходном тексте программ, написанных на языках C или C++, используется ключевое слово __stdcall, которое является специфическим для компиляторов от фирмы Microsoft(r). Обсуждаемое соглашение о связях характеризуется следующим:</span></p>
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 13px; margin: 2px 17px 3px 17px;"><span style="display:inline-block;width:13px;margin-left:-13px;font-size:10pt;font-family:'Symbol';font-style:normal;color:#565656;text-decoration:none;">•</span><span>вызывающая функция (в нашем случае mql4-программа) должна "видеть" прототип вызываемой (импортируемой из DLL) функции, для того чтобы правильно сложить параметры на стек;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 13px; margin: 2px 17px 3px 17px;"><span style="display:inline-block;width:13px;margin-left:-13px;font-size:10pt;font-family:'Symbol';font-style:normal;color:#565656;text-decoration:none;">•</span><span>вызывающая функция (в нашем случае mql4-программа) складывает параметры на стек в обратном порядке, справа налево - именно в таком порядке импортируемая функция считывает переданные ей параметры;</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 13px; margin: 2px 17px 3px 17px;"><span style="display:inline-block;width:13px;margin-left:-13px;font-size:10pt;font-family:'Symbol';font-style:normal;color:#565656;text-decoration:none;">•</span><span>параметры передаются по значению, за исключением тех, которые явно передаются по ссылке (в нашем случае строк);</span></p> 
<p style="text-align: justify; text-indent: 0px; padding: 0px 0px 0px 13px; margin: 2px 17px 3px 17px;"><span style="display:inline-block;width:13px;margin-left:-13px;font-size:10pt;font-family:'Symbol';font-style:normal;color:#565656;text-decoration:none;">•</span><span>импортируемая функция, считывая переданные ей параметры, сама очищает стек.</span></p> 
<p><span>При описании прототипа импортируемой функции можно использовать параметры со значениями по умолчанию.</span></p> 
<p><span>В случае если соответствующая библиотека не смогла загрузиться, либо установлен запрет на использование DLL, либо импортируемая функция не была найдена – эксперт останавливает свою работу с соответствующим сообщением "expert stopped" в журнале. При этом эксперт не будет запускаться, пока не будет заново проинициализирован. Эксперт может быть переинициализирован в результате перекомпиляции либо после открытия таблицы свойств эксперта и нажатия кнопки OK.</span></p> 
<h2>Передача параметров</h2> 
<p><span>Все параметры <a href="/basis/types#base_types">простых типов</a> передаются по значению, если явно не указано, что они &nbsp;передаются по ссылке. При передаче <a href="/basis/types/stringconst">строки</a> передается адрес буфера скопированной строки; если строка передается по ссылке, то в функцию, импортируемую из DLL, передается адрес буфера именно этой строки без копирования.</span></p>
<p><span><a href="/basis/types/classes">Структуры</a>, содержащие динамические массивы, строки, классы, другие сложные структуры, а также статические либо <a href="/basis/types/dynamic_array">динамические массивы</a> перечисленных объектов, не могут быть переданы в качестве параметра в импортируемую функцию.</span></p>
<p><span>При передаче в DLL массива всегда (независимо от флага <a href="/array/arraygetasseries">AS_SERIES</a>) передается адрес начала буфера данных. Функция внутри DLL ничего не знает о флаге AS_SERIES, переданный массив является статическим массивом неизвестной длины, для указания размера массива используйте дополнительный параметр.</span></p>
<br>